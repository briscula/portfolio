generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  /// The unique identifier for the user.
  id           String            @id @default(uuid()) @db.Uuid
  /// The user's name.
  name         String            @db.VarChar(255)
  /// The user's email address.
  email        String            @unique @db.VarChar(255)
  /// The user's hashed password.
  password     String            @db.VarChar(255)
  portfolios   Portfolio[]
  authAccounts UserAuthAccount[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt


  @@map("user")
}

model Portfolio {
  /// The unique identifier for the portfolio.
  id           String        @id @default(uuid()) @db.Uuid
  /// The ID of the user who owns the portfolio.
  userId       String        @db.Uuid
  /// The name of the portfolio.
  name         String        @db.VarChar(255)
  /// A description of the portfolio.
  description  String?       @db.VarChar(255)
  /// The base currency of the portfolio.
  currencyCode String        @default("USD") @db.VarChar(10)
  user         User          @relation(fields: [userId], references: [id])
  currency     Currency      @relation(fields: [currencyCode], references: [code])
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt


  @@unique([userId, name])
  @@map("portfolio")
}

model Currency {
  /// The currency code (e.g., "USD", "EUR").
  code         String        @id @db.VarChar(10)
  /// The name of the currency (e.g., "US Dollar", "Euro").
  name         String        @db.VarChar(50)
  /// The symbol of the currency (e.g., "$", "â‚¬").
  symbol       String        @db.VarChar(5)
  portfolios   Portfolio[]
  transactions Transaction[]
  listings     Listing[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("currency")
}

model Exchange {
  /// The exchange code (e.g., "NAS", "NYSE").
  code         String      @id @db.VarChar(10)
  /// The name of the exchange (e.g., "NASDAQ", "New York Stock Exchange").
  name         String      @db.VarChar(255)
  /// The country where the exchange is located.
  country      String      @db.VarChar(50)
  listings     Listing[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("exchange")
}

model Listing {
  /// The International Securities Identification Number (ISIN).
  isin             String      @db.VarChar(12)
  /// The code of the exchange where the stock is listed.
  exchangeCode     String      @db.VarChar(10)
  /// The ticker symbol of the stock on this exchange.
  tickerSymbol     String      @db.VarChar(10)
  /// The name of the company.
  companyName      String?     @db.VarChar(255)
  /// The currency of the listing.
  currencyCode     String      @db.VarChar(10)
  /// The current price of the stock.
  currentPrice     Float?
  /// The date the price was last updated.
  priceLastUpdated DateTime?
  /// The source of the price data (e.g., "yahoo_finance", "manual").
  priceSource      String?     @db.VarChar(50)

  exchange         Exchange    @relation(fields: [exchangeCode], references: [code])
  currency         Currency    @relation(fields: [currencyCode], references: [code])

  transactions     Transaction[]
  corporateActions CorporateAction[]

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@id([isin, exchangeCode])
  @@map("listing")
}

model CorporateAction {
  /// The unique identifier for the corporate action.
  id            Int                 @id @default(autoincrement())
  /// The ISIN of the listed stock affected by the corporate action.
  listingIsin   String              @db.VarChar(12)
  /// The exchange code of the listed stock affected by the corporate action.
  listingExchangeCode String          @db.VarChar(10)
  /// The type of corporate action.
  type          CorporateActionType
  /// The date the corporate action was executed.
  executionDate DateTime
  /// The factor of the corporate action (e.g., for splits).
  factor        Float?
  /// Additional notes about the corporate action.
  notes         String?
  listing       Listing             @relation(fields: [listingIsin, listingExchangeCode], references: [isin, exchangeCode])
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt


  @@map("corporate_action")
}


model Transaction {
  /// The unique identifier for the transaction.
  id            Int             @id @default(autoincrement())
  /// The ID of the portfolio the transaction belongs to.
  portfolioId   String          @db.Uuid
  /// The ISIN of the listed stock.
  listingIsin   String          @db.VarChar(12)
  /// The exchange code of the listed stock.
  listingExchangeCode String      @db.VarChar(10)
  /// The type of transaction.
  type          TransactionType @default(BUY)
  /// The number of shares in the transaction.
  quantity      Float
  /// The price per share.
  price         Float
  /// The commission paid for the transaction.
  commission    Float           @default(0)
  /// The currency of the transaction.
  currencyCode  String          @db.VarChar(10)
  /// Additional notes about the transaction.
  notes         String?
  /// The total amount of the transaction (quantity * price).
  amount        Float           @default(0)
  /// The total amount including fees/taxes.
  totalAmount   Float           @default(0)
  /// The tax paid for the transaction.
  tax           Float           @default(0)
  /// The tax percentage for the transaction.
  taxPercentage Float           @default(0)
  /// A reference for the transaction.
  reference     String?         @db.VarChar(255)
  portfolio     Portfolio       @relation(fields: [portfolioId], references: [id])
  listing       Listing         @relation(fields: [listingIsin, listingExchangeCode], references: [isin, exchangeCode])
  currency      Currency        @relation(fields: [currencyCode], references: [code])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt


  @@unique([portfolioId, listingIsin, listingExchangeCode, reference])
  @@map("transaction")
}

model UserAuthAccount {
  /// The unique identifier for the user auth account.
  id            Int          @id @default(autoincrement())
  /// The ID of the user.
  userId        String       @db.Uuid
  /// The authentication provider.
  provider      AuthProvider
  /// The user's ID from the authentication provider.
  providerSub   String       @db.VarChar(255)
  /// The user's email from the authentication provider.
  providerEmail String?      @db.VarChar(255)
  /// Whether the auth account is active.
  isActive      Boolean      @default(true)
  /// The date the auth account was last used.
  lastUsedAt    DateTime?
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([provider, providerSub])
  @@map("user_auth_account")
}

enum AuthProvider {
  AUTH0
  EMAIL_PASSWORD
}

model UserPosition {
  userId               String        @db.Uuid
  portfolioId          String        @db.Uuid
  portfolioName        String
  stockSymbol          String
  companyName          String?
  sector               String?
  currentQuantity      Float
  totalCost            Float
  totalDividends       Float
  dividendCount        Int
  lastTransactionDate  DateTime

  @@unique([userId, portfolioId, stockSymbol])
  @@map("user_positions")
}

enum CorporateActionType {
  SPLIT
  SPINOFF
  MERGER
}

enum TransactionType {
  DIVIDEND
  BUY
  SELL
  TAX
  CASH_DEPOSIT
  CASH_WITHDRAWAL
}